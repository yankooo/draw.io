<mxfile host="www.draw.io" modified="2019-12-28T03:05:05.604Z" agent="Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.88 Safari/537.36" etag="Y9dpg4xlRk9dTby0QO4r" version="12.4.7" type="github">
  <diagram id="CjRZhSOTHtSILFZinIMv" name="第 1 页">
    <mxGraphModel dx="4608" dy="1948" grid="0" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="0" pageScale="1" pageWidth="2920" pageHeight="2000" math="0" shadow="0">
      <root>
        <mxCell id="0"/>
        <mxCell id="1" parent="0"/>
        <mxCell id="EWBQogNj3lFvGu2faLvZ-1" value="&lt;pre style=&quot;background-color: #212121 ; color: #eeffff ; font-family: &amp;#34;consolas&amp;#34; ; font-size: 10.5pt&quot;&gt;&lt;pre style=&quot;font-family: &amp;#34;consolas&amp;#34; ; font-size: 10.5pt&quot;&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;// Server is a gRPC server to serve RPC requests.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;type &lt;/span&gt;&lt;span style=&quot;color: #ffcb6b&quot;&gt;Server &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;struct &lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;{&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   &lt;/span&gt;opts &lt;span style=&quot;color: #c3e88d&quot;&gt;serverOptions&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;   &lt;/span&gt;mu     sync&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;Mutex &lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;// guards following&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;   &lt;/span&gt;lis    &lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;map&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;[&lt;/span&gt;net&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;Listener&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;]&lt;/span&gt;&lt;span style=&quot;color: #c792ea&quot;&gt;bool&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c792ea&quot;&gt;   &lt;/span&gt;conns  &lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;map&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;[&lt;/span&gt;io&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;Closer&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;]&lt;/span&gt;&lt;span style=&quot;color: #c792ea&quot;&gt;bool&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c792ea&quot;&gt;   &lt;/span&gt;serve  &lt;span style=&quot;color: #c792ea&quot;&gt;bool&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c792ea&quot;&gt;   &lt;/span&gt;drain  &lt;span style=&quot;color: #c792ea&quot;&gt;bool&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c792ea&quot;&gt;   &lt;/span&gt;cv     &lt;span style=&quot;color: #89ddff&quot;&gt;*&lt;/span&gt;sync&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;Cond          &lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;// signaled when connections close for GracefulStop&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;   &lt;/span&gt;m      &lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;map&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #c792ea&quot;&gt;string&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;]*&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;service &lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;// service name -&amp;gt; service info&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;   &lt;/span&gt;events trace&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;EventLog&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;   &lt;/span&gt;quit               &lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;chan struct&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;{}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   &lt;/span&gt;done               &lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;chan struct&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;{}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   &lt;/span&gt;quitOnce           sync&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;Once&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;   &lt;/span&gt;doneOnce           sync&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;Once&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;   &lt;/span&gt;channelzRemoveOnce sync&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;Once&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;   &lt;/span&gt;serveWG            sync&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;WaitGroup &lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;// counts active Serve goroutines for GracefulStop&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;   &lt;/span&gt;channelzID &lt;span style=&quot;color: #c792ea&quot;&gt;int64 &lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;// channelz unique identification number&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;   &lt;/span&gt;czData     &lt;span style=&quot;color: #89ddff&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;channelzData&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;consolas&amp;#34; ; font-size: 10.5pt&quot;&gt;&lt;pre style=&quot;font-family: &amp;#34;consolas&amp;#34; ; font-size: 10.5pt&quot;&gt;&lt;span style=&quot;color: rgb(199 , 146 , 234) ; font-style: italic&quot;&gt;type &lt;/span&gt;&lt;span style=&quot;color: rgb(255 , 203 , 107)&quot;&gt;service &lt;/span&gt;&lt;span style=&quot;color: rgb(199 , 146 , 234) ; font-style: italic&quot;&gt;struct &lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;{&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;   &lt;/span&gt;server &lt;span style=&quot;color: rgb(199 , 146 , 234) ; font-style: italic&quot;&gt;interface&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;{} &lt;/span&gt;&lt;span style=&quot;color: rgb(97 , 97 , 97) ; font-style: italic&quot;&gt;// the server for service methods&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(97 , 97 , 97) ; font-style: italic&quot;&gt;   &lt;/span&gt;md     &lt;span style=&quot;color: rgb(199 , 146 , 234) ; font-style: italic&quot;&gt;map&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: rgb(199 , 146 , 234)&quot;&gt;string&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;]*&lt;/span&gt;&lt;span style=&quot;color: rgb(195 , 232 , 141)&quot;&gt;MethodDesc&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(195 , 232 , 141)&quot;&gt;   &lt;/span&gt;sd     &lt;span style=&quot;color: rgb(199 , 146 , 234) ; font-style: italic&quot;&gt;map&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: rgb(199 , 146 , 234)&quot;&gt;string&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;]*&lt;/span&gt;&lt;span style=&quot;color: rgb(195 , 232 , 141)&quot;&gt;StreamDesc  // 注册的时候用来存储rpc方法名和方法描述的（用来作为调用的时候映射的时候用）&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(195 , 232 , 141)&quot;&gt;   &lt;/span&gt;mdata  &lt;span style=&quot;color: rgb(199 , 146 , 234) ; font-style: italic&quot;&gt;interface&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;{}&lt;br&gt;&lt;div&gt;&lt;span style=&quot;font-size: 10.5pt ; white-space: normal&quot;&gt;}&lt;/span&gt;&lt;/div&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/pre&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: #212121 ; color: #eeffff ; font-family: &amp;#34;consolas&amp;#34; ; font-size: 10.5pt&quot;&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;&lt;div&gt;&lt;span style=&quot;font-size: 10.5pt ; white-space: normal&quot;&gt;// 对外的接口&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-size: 10.5pt ; white-space: normal ; color: rgb(199 , 146 , 234) ; font-style: italic&quot;&gt;func &lt;/span&gt;&lt;span style=&quot;font-size: 10.5pt ; white-space: normal&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-size: 10.5pt ; white-space: normal ; color: rgb(247 , 140 , 108)&quot;&gt;s &lt;/span&gt;&lt;span style=&quot;font-size: 10.5pt ; white-space: normal&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;font-size: 10.5pt ; white-space: normal ; color: rgb(195 , 232 , 141)&quot;&gt;Server&lt;/span&gt;&lt;span style=&quot;font-size: 10.5pt ; white-space: normal&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;font-size: 10.5pt ; white-space: normal ; color: rgb(130 , 170 , 255)&quot;&gt;RegisterService&lt;/span&gt;&lt;span style=&quot;font-size: 10.5pt ; white-space: normal&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-size: 10.5pt ; white-space: normal ; color: rgb(247 , 140 , 108)&quot;&gt;sd &lt;/span&gt;&lt;span style=&quot;font-size: 10.5pt ; white-space: normal&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;font-size: 10.5pt ; white-space: normal ; color: rgb(195 , 232 , 141)&quot;&gt;ServiceDesc&lt;/span&gt;&lt;span style=&quot;font-size: 10.5pt ; white-space: normal&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;font-size: 10.5pt ; white-space: normal ; color: rgb(247 , 140 , 108)&quot;&gt;ss &lt;/span&gt;&lt;span style=&quot;font-size: 10.5pt ; white-space: normal ; color: rgb(199 , 146 , 234) ; font-style: italic&quot;&gt;interface&lt;/span&gt;&lt;span style=&quot;font-size: 10.5pt ; white-space: normal&quot;&gt;{}) {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-size: 10.5pt ; white-space: normal&quot;&gt;&amp;nbsp; &amp;nbsp;...&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-size: 10.5pt ; white-space: normal ; color: rgb(247 , 140 , 108)&quot;&gt;&amp;nbsp; &amp;nbsp;s&lt;/span&gt;&lt;span style=&quot;font-size: 10.5pt ; white-space: normal&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;font-size: 10.5pt ; white-space: normal ; color: rgb(130 , 170 , 255)&quot;&gt;register&lt;/span&gt;&lt;span style=&quot;font-size: 10.5pt ; white-space: normal&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;font-size: 10.5pt ; white-space: normal ; color: rgb(247 , 140 , 108)&quot;&gt;sd&lt;/span&gt;&lt;span style=&quot;font-size: 10.5pt ; white-space: normal&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;font-size: 10.5pt ; white-space: normal ; color: rgb(247 , 140 , 108)&quot;&gt;ss&lt;/span&gt;&lt;span style=&quot;font-size: 10.5pt ; white-space: normal&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-size: 10.5pt ; white-space: normal&quot;&gt;}&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;pre style=&quot;color: rgb(238 , 255 , 255) ; font-family: &amp;#34;consolas&amp;#34; ; font-size: 10.5pt&quot;&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;&lt;br&gt;&lt;br&gt;// 用来注册rpc方法名映射关系，也就是 &lt;/span&gt;service的sd那个map变量&lt;span style=&quot;color: #89ddff&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;pre style=&quot;font-family: &amp;#34;consolas&amp;#34; ; font-size: 10.5pt&quot;&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;func &lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;s &lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;Server&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;register&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;sd &lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;ServiceDesc&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;ss &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;interface&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;{}) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;mu&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;Lock&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;()&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;defer &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;mu&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;Unlock&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;()&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   ...&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   &lt;/span&gt;srv &lt;span style=&quot;color: #89ddff&quot;&gt;:= &amp;amp;&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;service&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;{&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;server&lt;span style=&quot;color: #89ddff&quot;&gt;: &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;ss&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;,&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;md&lt;span style=&quot;color: #89ddff&quot;&gt;:     &lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;make&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;map&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #c792ea&quot;&gt;string&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;]*&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;MethodDesc&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;),&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;sd&lt;span style=&quot;color: #89ddff&quot;&gt;:     &lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;make&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;map&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #c792ea&quot;&gt;string&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;]*&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;StreamDesc&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;),&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;mdata&lt;span style=&quot;color: #89ddff&quot;&gt;:  &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;sd&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;Metadata&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;,&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   }&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;for &lt;/span&gt;i &lt;span style=&quot;color: #89ddff&quot;&gt;:= &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;range &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;sd&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;Methods &lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;{&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;d &lt;span style=&quot;color: #89ddff&quot;&gt;:= &amp;amp;&lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;sd&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;Methods&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;[&lt;/span&gt;i&lt;span style=&quot;color: #89ddff&quot;&gt;]&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;srv&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;md&lt;span style=&quot;color: #89ddff&quot;&gt;[&lt;/span&gt;d&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;MethodName&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;] = &lt;/span&gt;d&lt;br&gt;   &lt;span style=&quot;color: #89ddff&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;for &lt;/span&gt;i &lt;span style=&quot;color: #89ddff&quot;&gt;:= &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;range &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;sd&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;Streams &lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;{&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;d &lt;span style=&quot;color: #89ddff&quot;&gt;:= &amp;amp;&lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;sd&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;Streams&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;[&lt;/span&gt;i&lt;span style=&quot;color: #89ddff&quot;&gt;]&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;srv&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;sd&lt;span style=&quot;color: #89ddff&quot;&gt;[&lt;/span&gt;d&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;StreamName&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;] = &lt;/span&gt;d&lt;br&gt;   &lt;span style=&quot;color: #89ddff&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;m&lt;span style=&quot;color: #89ddff&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;sd&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;ServiceName&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;] = &lt;/span&gt;srv&lt;br&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/span&gt;&lt;/pre&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;" vertex="1" parent="1">
          <mxGeometry x="-2907" y="-456" width="804" height="1023" as="geometry"/>
        </mxCell>
        <mxCell id="EWBQogNj3lFvGu2faLvZ-2" value="1. server注册" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="-2907" y="-476" width="80" height="10" as="geometry"/>
        </mxCell>
        <mxCell id="EWBQogNj3lFvGu2faLvZ-3" value="&lt;pre style=&quot;background-color: #212121 ; color: #eeffff ; font-family: &amp;#34;consolas&amp;#34; ; font-size: 10.5pt&quot;&gt;&lt;pre style=&quot;font-family: &amp;#34;consolas&amp;#34; ; font-size: 10.5pt&quot;&gt;&lt;span style=&quot;color: rgb(97 , 97 , 97) ; font-size: 10.5pt ; font-style: italic ; white-space: normal&quot;&gt;// Serve accepts incoming connections on the listener lis, creating a new&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;consolas&amp;#34; ; font-size: 10.5pt&quot;&gt;&lt;div&gt;&lt;pre style=&quot;background-color: rgb(33 , 33 , 33) ; font-family: &amp;#34;consolas&amp;#34; ; font-size: 10.5pt&quot;&gt;&lt;span style=&quot;color: rgb(97 , 97 , 97) ; font-style: italic&quot;&gt;// ServerTransport and service goroutine for each. The service goroutines&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(97 , 97 , 97) ; font-style: italic&quot;&gt;// read gRPC requests and then call the registered handlers to reply to them.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(97 , 97 , 97) ; font-style: italic&quot;&gt;// Serve returns when lis.Accept fails with fatal errors.  lis will be closed when&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(97 , 97 , 97) ; font-style: italic&quot;&gt;// this method returns.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(97 , 97 , 97) ; font-style: italic&quot;&gt;// Serve will return a non-nil error unless Stop or GracefulStop is called.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(199 , 146 , 234) ; font-style: italic&quot;&gt;func &lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: rgb(247 , 140 , 108)&quot;&gt;s &lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: rgb(195 , 232 , 141)&quot;&gt;Server&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: rgb(130 , 170 , 255)&quot;&gt;Serve&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: rgb(247 , 140 , 108)&quot;&gt;lis &lt;/span&gt;&lt;font color=&quot;#eeffff&quot;&gt;net&lt;/font&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: rgb(195 , 232 , 141)&quot;&gt;Listener&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: rgb(199 , 146 , 234)&quot;&gt;error &lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;{&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;   ...&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;   &lt;/span&gt;&lt;font color=&quot;#eeffff&quot;&gt;ls &lt;/font&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;:= &amp;amp;&lt;/span&gt;&lt;span style=&quot;color: rgb(195 , 232 , 141)&quot;&gt;listenSocket&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;{&lt;/span&gt;&lt;font color=&quot;#eeffff&quot;&gt;Listener&lt;/font&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;: &lt;/span&gt;&lt;span style=&quot;color: rgb(247 , 140 , 108)&quot;&gt;lis&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: rgb(247 , 140 , 108)&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;.&lt;/span&gt;&lt;font color=&quot;#eeffff&quot;&gt;lis&lt;/font&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;[&lt;/span&gt;&lt;font color=&quot;#eeffff&quot;&gt;ls&lt;/font&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;] = &lt;/span&gt;&lt;span style=&quot;color: rgb(247 , 140 , 108)&quot;&gt;true&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(247 , 140 , 108)&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;font color=&quot;#f78c6c&quot;&gt;   ...&lt;/font&gt;&lt;font color=&quot;#89ddff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: rgb(199 , 146 , 234) ; font-style: italic&quot;&gt;var &lt;/span&gt;&lt;font color=&quot;#eeffff&quot;&gt;tempDelay time&lt;/font&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: rgb(195 , 232 , 141)&quot;&gt;Duration &lt;/span&gt;&lt;span style=&quot;color: rgb(97 , 97 , 97) ; font-style: italic&quot;&gt;// how long to sleep on accept failure&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(97 , 97 , 97) ; font-style: italic&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(97 , 97 , 97) ; font-style: italic&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: rgb(199 , 146 , 234) ; font-style: italic&quot;&gt;for &lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;{&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;      &lt;/span&gt;&lt;font color=&quot;#eeffff&quot;&gt;rawConn&lt;/font&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;, &lt;/span&gt;&lt;font color=&quot;#eeffff&quot;&gt;err &lt;/font&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;:= &lt;/span&gt;&lt;span style=&quot;color: rgb(247 , 140 , 108)&quot;&gt;lis&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: rgb(130 , 170 , 255)&quot;&gt;Accept&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;()&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;color: rgb(199 , 146 , 234) ; font-style: italic&quot;&gt;if &lt;/span&gt;&lt;font color=&quot;#eeffff&quot;&gt;err &lt;/font&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;!= &lt;/span&gt;&lt;font color=&quot;#eeffff&quot;&gt;nil &lt;/font&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;{&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;         &lt;/span&gt;&lt;font color=&quot;#c792ea&quot;&gt;&lt;i&gt;...&lt;/i&gt;&lt;/font&gt;&lt;font color=&quot;#eeffff&quot;&gt;&lt;br&gt;      &lt;/font&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;      &lt;/span&gt;&lt;font color=&quot;#eeffff&quot;&gt;tempDelay &lt;/font&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;color: rgb(247 , 140 , 108)&quot;&gt;0&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(247 , 140 , 108)&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;color: rgb(97 , 97 , 97) ; font-style: italic&quot;&gt;// Start a new goroutine to deal with rawConn so we don&#39;t stall this Accept&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(97 , 97 , 97) ; font-style: italic&quot;&gt;      // loop goroutine.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(97 , 97 , 97) ; font-style: italic&quot;&gt;      //&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(97 , 97 , 97) ; font-style: italic&quot;&gt;      // Make sure we account for the goroutine so GracefulStop doesn&#39;t nil out&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(97 , 97 , 97) ; font-style: italic&quot;&gt;      // s.conns before this conn can be added.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(97 , 97 , 97) ; font-style: italic&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;color: rgb(247 , 140 , 108)&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;.&lt;/span&gt;&lt;font color=&quot;#eeffff&quot;&gt;serveWG&lt;/font&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: rgb(130 , 170 , 255)&quot;&gt;Add&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: rgb(247 , 140 , 108)&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;color: rgb(199 , 146 , 234) ; font-style: italic&quot;&gt;go func&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;() {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;         &lt;/span&gt;&lt;span style=&quot;color: rgb(247 , 140 , 108)&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: rgb(130 , 170 , 255)&quot;&gt;handleRawConn&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;(&lt;/span&gt;&lt;font color=&quot;#eeffff&quot;&gt;rawConn&lt;/font&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;)   // 有一个连接，就开启一个协程去处理&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;         &lt;/span&gt;&lt;span style=&quot;color: rgb(247 , 140 , 108)&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;.&lt;/span&gt;&lt;font color=&quot;#eeffff&quot;&gt;serveWG&lt;/font&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: rgb(130 , 170 , 255)&quot;&gt;Done&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;()&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;      }()&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;   }&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;consolas&amp;#34; ; font-size: 10.5pt&quot;&gt;&lt;pre style=&quot;background-color: rgb(33 , 33 , 33) ; color: rgb(238 , 255 , 255) ; font-family: &amp;#34;consolas&amp;#34; ; font-size: 10.5pt&quot;&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;// handleRawConn forks a goroutine to handle a just-accepted connection that&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;// has not had any I/O performed on it yet.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;func &lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;s &lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;Server&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;handleRawConn&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;rawConn &lt;/span&gt;net&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;Conn&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;rawConn&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;SetDeadline&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;time&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;Now&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;().&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;Add&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;opts&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;connectionTimeout&lt;span style=&quot;color: #89ddff&quot;&gt;))&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   &lt;/span&gt;conn&lt;span style=&quot;color: #89ddff&quot;&gt;, &lt;/span&gt;authInfo&lt;span style=&quot;color: #89ddff&quot;&gt;, &lt;/span&gt;err &lt;span style=&quot;color: #89ddff&quot;&gt;:= &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;useTransportAuthenticator&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;rawConn&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;if &lt;/span&gt;err &lt;span style=&quot;color: #89ddff&quot;&gt;!= &lt;/span&gt;nil &lt;span style=&quot;color: #89ddff&quot;&gt;{&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;// ErrConnDispatched means that the connection was dispatched away from&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;      // gRPC; those connections should be left open.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;if &lt;/span&gt;err &lt;span style=&quot;color: #89ddff&quot;&gt;!= &lt;/span&gt;credentials&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;ErrConnDispatched &lt;span style=&quot;color: #89ddff&quot;&gt;{&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;         &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;mu&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;Lock&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;()&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;         &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;errorf&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;&quot;ServerHandshake(%q) failed: %v&quot;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;rawConn&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;RemoteAddr&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(), &lt;/span&gt;err&lt;span style=&quot;color: #89ddff&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;         &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;mu&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;Unlock&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;()&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;         &lt;/span&gt;grpclog&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;Warningf&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;&quot;grpc: Server.Serve failed to complete security handshake from %q: %v&quot;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;rawConn&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;RemoteAddr&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(), &lt;/span&gt;err&lt;span style=&quot;color: #89ddff&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;         &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;rawConn&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;Close&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;()&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      }&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;rawConn&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;SetDeadline&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;time&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;Time&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;{})&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;return&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;mu&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;Lock&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;()&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;conns &lt;span style=&quot;color: #89ddff&quot;&gt;== &lt;/span&gt;nil &lt;span style=&quot;color: #89ddff&quot;&gt;{&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;mu&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;Unlock&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;()&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;conn&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;Close&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;()&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;return&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;mu&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;Unlock&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;()&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;// Finish handshaking (HTTP2)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;   &lt;/span&gt;st &lt;span style=&quot;color: #89ddff&quot;&gt;:= &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;newHTTP2Transport&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;conn&lt;span style=&quot;color: #89ddff&quot;&gt;, &lt;/span&gt;authInfo&lt;span style=&quot;color: #89ddff&quot;&gt;)  // 基于http2.0,所以会先初始化传输层，比如按帧读取http流的数据的操作&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;if &lt;/span&gt;st &lt;span style=&quot;color: #89ddff&quot;&gt;== &lt;/span&gt;nil &lt;span style=&quot;color: #89ddff&quot;&gt;{&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;return&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;rawConn&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;SetDeadline&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;time&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;Time&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;{})&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;!&lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;addConn&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;st&lt;span style=&quot;color: #89ddff&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;return&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;go func&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;() {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;serveStreams&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;st&lt;span style=&quot;color: #89ddff&quot;&gt;)   // 使用传输层来处理调用&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;removeConn&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;st&lt;span style=&quot;color: #89ddff&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   }()&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: rgb(33 , 33 , 33) ; color: rgb(238 , 255 , 255) ; font-family: &amp;#34;consolas&amp;#34; ; font-size: 10.5pt&quot;&gt;&lt;pre style=&quot;font-family: &amp;#34;consolas&amp;#34; ; font-size: 10.5pt&quot;&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;func &lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;s &lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;Server&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;serveStreams&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;st &lt;/span&gt;transport&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;ServerTransport&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;defer &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;st&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;Close&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;()&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;var &lt;/span&gt;wg sync&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;WaitGroup&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;st&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;HandleStreams&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;func&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;stream &lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;*&lt;/span&gt;transport&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;Stream&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;wg&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;Add&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;go func&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;() {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;         &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;defer &lt;/span&gt;wg&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;Done&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;()&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;         &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;handleStream&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;st&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;stream&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;traceInfo&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;st&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;stream&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;))&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      }()&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   }, &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;func&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;ctx &lt;/span&gt;context&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;Context&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;method &lt;/span&gt;&lt;span style=&quot;color: #c792ea&quot;&gt;string&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;) &lt;/span&gt;context&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;Context &lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;{&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;!&lt;/span&gt;EnableTracing &lt;span style=&quot;color: #89ddff&quot;&gt;{&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;         &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;return &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;ctx&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;tr &lt;span style=&quot;color: #89ddff&quot;&gt;:= &lt;/span&gt;trace&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;New&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;&quot;grpc.Recv.&quot;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;methodFamily&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;method&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;), &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;method&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;return &lt;/span&gt;trace&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;NewContext&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;, &lt;/span&gt;tr&lt;span style=&quot;color: #89ddff&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   })&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   &lt;/span&gt;wg&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;Wait&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;()&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;&lt;/pre&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/pre&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;" vertex="1" parent="1">
          <mxGeometry x="-2071" y="-456" width="963" height="1545" as="geometry"/>
        </mxCell>
        <mxCell id="EWBQogNj3lFvGu2faLvZ-4" value="2. server监听与调用" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="-2074" y="-474" width="118" height="10" as="geometry"/>
        </mxCell>
        <mxCell id="EWBQogNj3lFvGu2faLvZ-6" value="" style="rounded=0;whiteSpace=wrap;html=1;strokeColor=#FF0000;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="-1980" y="-82" width="469" height="19" as="geometry"/>
        </mxCell>
        <mxCell id="EWBQogNj3lFvGu2faLvZ-8" value="" style="curved=1;endArrow=classic;html=1;exitX=0.628;exitY=-0.08;exitDx=0;exitDy=0;exitPerimeter=0;strokeColor=#FF0000;" edge="1" parent="1" source="EWBQogNj3lFvGu2faLvZ-6" target="EWBQogNj3lFvGu2faLvZ-9">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-2095" y="-47" as="sourcePoint"/>
            <mxPoint x="-2074" y="-12" as="targetPoint"/>
            <Array as="points">
              <mxPoint x="-1781" y="-44"/>
              <mxPoint x="-1805" y="2"/>
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="EWBQogNj3lFvGu2faLvZ-9" value="" style="rounded=0;whiteSpace=wrap;html=1;strokeColor=#FF0000;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="-2046" y="44" width="398" height="18" as="geometry"/>
        </mxCell>
        <mxCell id="EWBQogNj3lFvGu2faLvZ-11" value="" style="rounded=0;whiteSpace=wrap;html=1;strokeColor=#FF0000;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="-2025" y="720" width="140" height="20" as="geometry"/>
        </mxCell>
        <mxCell id="EWBQogNj3lFvGu2faLvZ-12" value="&lt;pre style=&quot;background-color: #212121 ; color: #eeffff ; font-family: &amp;#34;consolas&amp;#34; ; font-size: 10.5pt&quot;&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;// newHTTP2Transport sets up a http/2 transport (using the&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;// gRPC http2 server transport in transport/http2_server.go).&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;func &lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;s &lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;Server&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;newHTTP2Transport&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;c &lt;/span&gt;net&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;Conn&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;authInfo &lt;/span&gt;credentials&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;AuthInfo&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;) &lt;/span&gt;transport&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;ServerTransport &lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;{&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   &lt;/span&gt;config &lt;span style=&quot;color: #89ddff&quot;&gt;:= &amp;amp;&lt;/span&gt;transport&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;ServerConfig&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;{&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;MaxStreams&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;:            &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;opts&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;maxConcurrentStreams&lt;span style=&quot;color: #89ddff&quot;&gt;,&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;AuthInfo&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;:              &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;authInfo&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;,&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;InTapHandle&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;:           &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;opts&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;inTapHandle&lt;span style=&quot;color: #89ddff&quot;&gt;,&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;StatsHandler&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;:          &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;opts&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;statsHandler&lt;span style=&quot;color: #89ddff&quot;&gt;,&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;KeepaliveParams&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;:       &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;opts&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;keepaliveParams&lt;span style=&quot;color: #89ddff&quot;&gt;,&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;KeepalivePolicy&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;:       &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;opts&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;keepalivePolicy&lt;span style=&quot;color: #89ddff&quot;&gt;,&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;InitialWindowSize&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;:     &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;opts&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;initialWindowSize&lt;span style=&quot;color: #89ddff&quot;&gt;,&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;InitialConnWindowSize&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;: &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;opts&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;initialConnWindowSize&lt;span style=&quot;color: #89ddff&quot;&gt;,&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;WriteBufferSize&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;:       &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;opts&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;writeBufferSize&lt;span style=&quot;color: #89ddff&quot;&gt;,&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;ReadBufferSize&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;:        &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;opts&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;readBufferSize&lt;span style=&quot;color: #89ddff&quot;&gt;,&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;ChannelzParentID&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;:      &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;channelzID&lt;span style=&quot;color: #89ddff&quot;&gt;,&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;MaxHeaderListSize&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;:     &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;opts&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;maxHeaderListSize&lt;span style=&quot;color: #89ddff&quot;&gt;,&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   }&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   &lt;/span&gt;st&lt;span style=&quot;color: #89ddff&quot;&gt;, &lt;/span&gt;err &lt;span style=&quot;color: #89ddff&quot;&gt;:= &lt;/span&gt;transport&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;NewServerTransport&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;&quot;http2&quot;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;c&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;, &lt;/span&gt;config&lt;span style=&quot;color: #89ddff&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;if &lt;/span&gt;err &lt;span style=&quot;color: #89ddff&quot;&gt;!= &lt;/span&gt;nil &lt;span style=&quot;color: #89ddff&quot;&gt;{&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;mu&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;Lock&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;()&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;errorf&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;&quot;NewServerTransport(%q) failed: %v&quot;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;c&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;RemoteAddr&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(), &lt;/span&gt;err&lt;span style=&quot;color: #89ddff&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;mu&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;Unlock&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;()&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;c&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;Close&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;()&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;grpclog&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;Warningln&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;&quot;grpc: Server.Serve failed to create ServerTransport: &quot;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;, &lt;/span&gt;err&lt;span style=&quot;color: #89ddff&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;return &lt;/span&gt;nil&lt;br&gt;   &lt;span style=&quot;color: #89ddff&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;return &lt;/span&gt;st&lt;br&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: #212121 ; color: #eeffff ; font-family: &amp;#34;consolas&amp;#34; ; font-size: 10.5pt&quot;&gt;&lt;pre style=&quot;font-family: &amp;#34;consolas&amp;#34; ; font-size: 10.5pt&quot;&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;// NewServerTransport creates a ServerTransport with conn or non-nil error&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;// if it fails.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;func &lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;NewServerTransport&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;protocol &lt;/span&gt;&lt;span style=&quot;color: #c792ea&quot;&gt;string&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;conn &lt;/span&gt;net&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;Conn&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;config &lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;ServerConfig&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;) (&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;ServerTransport&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #c792ea&quot;&gt;error&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;return &lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;newHTTP2Server&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;conn&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;config&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: #212121 ; color: #eeffff ; font-family: &amp;#34;consolas&amp;#34; ; font-size: 10.5pt&quot;&gt;&lt;pre style=&quot;font-family: &amp;#34;consolas&amp;#34; ; font-size: 10.5pt&quot;&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;// newHTTP2Server constructs a ServerTransport based on HTTP2. ConnectionError is&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;// returned if something goes wrong.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;func &lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;newHTTP2Server&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;conn &lt;/span&gt;net&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;Conn&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;config &lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;ServerConfig&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;) (&lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;_ &lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;ServerTransport&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;err &lt;/span&gt;&lt;span style=&quot;color: #c792ea&quot;&gt;error&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   &lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;consolas&amp;#34; ; font-size: 10.5pt&quot;&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   ...&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   &lt;/span&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;consolas&amp;#34; ; font-size: 10.5pt&quot;&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   // 这个http2Server很重要，提供了上层server会调用的 &lt;/span&gt;HandleStreams()方法&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;consolas&amp;#34; ; font-size: 10.5pt&quot;&gt;&lt;span style=&quot;font-size: 10.5pt ; white-space: normal&quot;&gt;&amp;nbsp; &amp;nbsp;t &lt;/span&gt;&lt;span style=&quot;font-size: 10.5pt ; white-space: normal ; color: rgb(137 , 221 , 255)&quot;&gt;:= &amp;amp;&lt;/span&gt;&lt;span style=&quot;font-size: 10.5pt ; white-space: normal ; color: rgb(195 , 232 , 141)&quot;&gt;http2Server&lt;/span&gt;&lt;span style=&quot;font-size: 10.5pt ; white-space: normal ; color: rgb(137 , 221 , 255)&quot;&gt;{&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;pre style=&quot;font-family: &amp;#34;consolas&amp;#34; ; font-size: 10.5pt&quot;&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;ctx&lt;span style=&quot;color: #89ddff&quot;&gt;:               &lt;/span&gt;ctx&lt;span style=&quot;color: #89ddff&quot;&gt;,&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;cancel&lt;span style=&quot;color: #89ddff&quot;&gt;:            &lt;/span&gt;cancel&lt;span style=&quot;color: #89ddff&quot;&gt;,&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;ctxDone&lt;span style=&quot;color: #89ddff&quot;&gt;:           &lt;/span&gt;ctx&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;Done&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(),&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;conn&lt;span style=&quot;color: #89ddff&quot;&gt;:              &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;conn&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;,&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;remoteAddr&lt;span style=&quot;color: #89ddff&quot;&gt;:        &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;conn&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;RemoteAddr&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(),&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;localAddr&lt;span style=&quot;color: #89ddff&quot;&gt;:         &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;conn&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;LocalAddr&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(),&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;authInfo&lt;span style=&quot;color: #89ddff&quot;&gt;:          &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;config&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;AuthInfo&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;,&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;framer&lt;span style=&quot;color: #89ddff&quot;&gt;:            &lt;/span&gt;framer&lt;span style=&quot;color: #89ddff&quot;&gt;,&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;readerDone&lt;span style=&quot;color: #89ddff&quot;&gt;:        &lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;make&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;chan struct&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;{}),&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;writerDone&lt;span style=&quot;color: #89ddff&quot;&gt;:        &lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;make&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;chan struct&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;{}),&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;maxStreams&lt;span style=&quot;color: #89ddff&quot;&gt;:        &lt;/span&gt;maxStreams&lt;span style=&quot;color: #89ddff&quot;&gt;,&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;inTapHandle&lt;span style=&quot;color: #89ddff&quot;&gt;:       &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;config&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;InTapHandle&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;,&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;fc&lt;span style=&quot;color: #89ddff&quot;&gt;:                &amp;amp;&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;trInFlow&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;{&lt;/span&gt;limit&lt;span style=&quot;color: #89ddff&quot;&gt;: &lt;/span&gt;&lt;span style=&quot;color: #c792ea&quot;&gt;uint32&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;icwz&lt;span style=&quot;color: #89ddff&quot;&gt;)},&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;state&lt;span style=&quot;color: #89ddff&quot;&gt;:             &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;reachable&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;,&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;activeStreams&lt;span style=&quot;color: #89ddff&quot;&gt;:     &lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;make&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;map&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #c792ea&quot;&gt;uint32&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;]*&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;Stream&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;),&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;stats&lt;span style=&quot;color: #89ddff&quot;&gt;:             &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;config&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;font-style: italic&quot;&gt;StatsHandler&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;,&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;kp&lt;span style=&quot;color: #89ddff&quot;&gt;:                &lt;/span&gt;kp&lt;span style=&quot;color: #89ddff&quot;&gt;,&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;idle&lt;span style=&quot;color: #89ddff&quot;&gt;:              &lt;/span&gt;time&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;Now&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(),&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;kep&lt;span style=&quot;color: #89ddff&quot;&gt;:               &lt;/span&gt;kep&lt;span style=&quot;color: #89ddff&quot;&gt;,&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;initialWindowSize&lt;span style=&quot;color: #89ddff&quot;&gt;: &lt;/span&gt;iwz&lt;span style=&quot;color: #89ddff&quot;&gt;,&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;czData&lt;span style=&quot;color: #89ddff&quot;&gt;:            &lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;channelzData&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;),&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   }&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   ...&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;go func&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;() {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      ...&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   }()&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;go &lt;/span&gt;t&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;keepalive&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;()&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;return &lt;/span&gt;t&lt;span style=&quot;color: #89ddff&quot;&gt;, &lt;/span&gt;nil&lt;br&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;&lt;/pre&gt;" style="rounded=0;whiteSpace=wrap;html=1;strokeColor=#000000;fillColor=none;align=left;" vertex="1" parent="1">
          <mxGeometry x="-1227" y="-1136" width="822" height="1309" as="geometry"/>
        </mxCell>
        <mxCell id="EWBQogNj3lFvGu2faLvZ-13" value="" style="rounded=0;whiteSpace=wrap;html=1;strokeColor=#FF0000;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="-2004" y="558" width="275" height="23" as="geometry"/>
        </mxCell>
        <mxCell id="EWBQogNj3lFvGu2faLvZ-14" value="&lt;pre style=&quot;background-color: #212121 ; color: #eeffff ; font-family: &amp;#34;consolas&amp;#34; ; font-size: 10.5pt&quot;&gt;&lt;pre style=&quot;font-family: &amp;#34;consolas&amp;#34; ; font-size: 10.5pt&quot;&gt;&lt;pre style=&quot;font-family: &amp;#34;consolas&amp;#34; ; font-size: 10.5pt&quot;&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;// http2Server implements the ServerTransport interface with HTTP2.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;type &lt;/span&gt;&lt;span style=&quot;color: #ffcb6b&quot;&gt;http2Server &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;struct &lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;{&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   &lt;/span&gt;ctx         context&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;Context&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;   &lt;/span&gt;ctxDone     &lt;span style=&quot;color: #89ddff&quot;&gt;&amp;lt;-&lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;chan struct&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;{} &lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;// Cache the context.Done() chan&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;   &lt;/span&gt;cancel      context&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;CancelFunc&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;   &lt;/span&gt;conn        net&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;Conn&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;   &lt;/span&gt;loopy       &lt;span style=&quot;color: #89ddff&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;loopyWriter&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;   &lt;/span&gt;readerDone  &lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;chan struct&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;{} &lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;// sync point to enable testing.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;   &lt;/span&gt;writerDone  &lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;chan struct&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;{} &lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;// sync point to enable testing.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;   &lt;/span&gt;remoteAddr  net&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;Addr&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;   &lt;/span&gt;localAddr   net&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;Addr&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;   &lt;/span&gt;maxStreamID &lt;span style=&quot;color: #c792ea&quot;&gt;uint32               &lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;// max stream ID ever seen&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;   &lt;/span&gt;authInfo    credentials&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;AuthInfo &lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;// auth info about the connection&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;   &lt;/span&gt;inTapHandle tap&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;ServerInHandle&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;   &lt;/span&gt;framer      &lt;span style=&quot;color: #89ddff&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;framer&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;// The max number of concurrent streams.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;   &lt;/span&gt;maxStreams &lt;span style=&quot;color: #c792ea&quot;&gt;uint32&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c792ea&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;// controlBuf delivers all the control related tasks (e.g., window&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;   // updates, reset streams, and various settings) to the controller.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;   &lt;/span&gt;controlBuf &lt;span style=&quot;color: #89ddff&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;controlBuffer&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;   &lt;/span&gt;fc         &lt;span style=&quot;color: #89ddff&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;trInFlow&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;   &lt;/span&gt;stats      stats&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;Handler&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;// Flag to keep track of reading activity on transport.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;   // 1 is true and 0 is false.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;   &lt;/span&gt;activity &lt;span style=&quot;color: #c792ea&quot;&gt;uint32 &lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;// Accessed atomically.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;   // Keepalive and max-age parameters for the server.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;   &lt;/span&gt;kp keepalive&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;ServerParameters&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;// Keepalive enforcement policy.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;   &lt;/span&gt;kep keepalive&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;EnforcementPolicy&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;// The time instance last ping was received.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;   &lt;/span&gt;lastPingAt time&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;Time&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;// Number of times the client has violated keepalive ping policy so far.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;   &lt;/span&gt;pingStrikes &lt;span style=&quot;color: #c792ea&quot;&gt;uint8&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c792ea&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;// Flag to signify that number of ping strikes should be reset to 0.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;   // This is set whenever data or header frames are sent.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;   // 1 means yes.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;   &lt;/span&gt;resetPingStrikes      &lt;span style=&quot;color: #c792ea&quot;&gt;uint32 &lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;// Accessed atomically.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;   &lt;/span&gt;initialWindowSize     &lt;span style=&quot;color: #c792ea&quot;&gt;int32&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c792ea&quot;&gt;   &lt;/span&gt;bdpEst                &lt;span style=&quot;color: #89ddff&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;bdpEstimator&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;   &lt;/span&gt;maxSendHeaderListSize &lt;span style=&quot;color: #89ddff&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #c792ea&quot;&gt;uint32&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c792ea&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c792ea&quot;&gt;   &lt;/span&gt;mu sync&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;Mutex &lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;// guard the following&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;   // drainChan is initialized when drain(...) is called the first time.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;   // After which the server writes out the first GoAway(with ID 2^31-1) frame.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;   // Then an independent goroutine will be launched to later send the second GoAway.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;   // During this time we don&#39;t want to write another first GoAway(with ID 2^31 -1) frame.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;   // Thus call to drain(...) will be a no-op if drainChan is already initialized since draining is&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;   // already underway.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;   &lt;/span&gt;drainChan     &lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;chan struct&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;{}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   &lt;/span&gt;state         &lt;span style=&quot;color: #c3e88d&quot;&gt;transportState&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;   &lt;/span&gt;activeStreams &lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;map&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #c792ea&quot;&gt;uint32&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;]*&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;Stream&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;// idle is the time instant when the connection went idle.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;   // This is either the beginning of the connection or when the number of&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;   // RPCs go down to 0.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;   // When the connection is busy, this value is set to 0.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;   &lt;/span&gt;idle time&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;Time&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;// Fields below are for channelz metric collection.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;   &lt;/span&gt;channelzID &lt;span style=&quot;color: #c792ea&quot;&gt;int64 &lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;// channelz unique identification number&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;   &lt;/span&gt;czData     &lt;span style=&quot;color: #89ddff&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;channelzData&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;&lt;/pre&gt;&lt;/pre&gt;&lt;pre style=&quot;background-color: #212121 ; color: #eeffff ; font-family: &amp;#34;consolas&amp;#34; ; font-size: 10.5pt&quot;&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;&lt;div&gt;&lt;span style=&quot;font-size: 10.5pt ; white-space: normal&quot;&gt;// 对外的接口&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;pre style=&quot;color: rgb(238 , 255 , 255) ; font-family: &amp;#34;consolas&amp;#34; ; font-size: 10.5pt&quot;&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;// HandleStreams receives incoming streams using the given handler. This is&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;// typically run in a separate goroutine.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;// traceCtx attaches trace to ctx and returns the new context.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;func &lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;t &lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;http2Server&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;HandleStreams&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;handle &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;func&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(*&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;Stream&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;), &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;traceCtx &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;func&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;context&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;Context&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #c792ea&quot;&gt;string&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;) &lt;/span&gt;context&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;Context&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;defer &lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;close&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;t&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;readerDone&lt;span style=&quot;color: #89ddff&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;for &lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;{&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;frame&lt;span style=&quot;color: #89ddff&quot;&gt;, &lt;/span&gt;err &lt;span style=&quot;color: #89ddff&quot;&gt;:= &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;t&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;framer&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;fr&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;ReadFrame&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;()&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      ...&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;switch &lt;/span&gt;frame &lt;span style=&quot;color: #89ddff&quot;&gt;:= &lt;/span&gt;frame&lt;span style=&quot;color: #89ddff&quot;&gt;.(&lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;type&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;case &lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;*&lt;/span&gt;http2&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;MetaHeadersFrame&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;:&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;         &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;t&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;operateHeaders&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;frame&lt;span style=&quot;color: #89ddff&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;handle&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;traceCtx&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;t&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;Close&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;()&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;break&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;         &lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;case &lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;*&lt;/span&gt;http2&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;DataFrame&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;:&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;         &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;t&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;handleData&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;frame&lt;span style=&quot;color: #89ddff&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;case &lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;*&lt;/span&gt;http2&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;RSTStreamFrame&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;:&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;         &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;t&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;handleRSTStream&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;frame&lt;span style=&quot;color: #89ddff&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;case &lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;*&lt;/span&gt;http2&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;SettingsFrame&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;:&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;         &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;t&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;handleSettings&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;frame&lt;span style=&quot;color: #89ddff&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;case &lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;*&lt;/span&gt;http2&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;PingFrame&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;:&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;         &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;t&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;handlePing&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;frame&lt;span style=&quot;color: #89ddff&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;case &lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;*&lt;/span&gt;http2&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;WindowUpdateFrame&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;:&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;         &lt;/span&gt;&lt;span style=&quot;color: #f78c6c&quot;&gt;t&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;handleWindowUpdate&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;frame&lt;span style=&quot;color: #89ddff&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;case &lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;*&lt;/span&gt;http2&lt;span style=&quot;color: #89ddff&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;GoAwayFrame&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;:&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;         &lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;// TODO: Handle GoAway from the client appropriately.&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #616161 ; font-style: italic&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;color: #c792ea ; font-style: italic&quot;&gt;default&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;:&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;         &lt;/span&gt;&lt;span style=&quot;color: #82aaff&quot;&gt;errorf&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #c3e88d&quot;&gt;&quot;transport: http2Server.HandleStreams found unhandled frame type %v.&quot;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;, &lt;/span&gt;frame&lt;span style=&quot;color: #89ddff&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;      }&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;   }&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #89ddff&quot;&gt;}&lt;br&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/span&gt;&lt;/pre&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;" vertex="1" parent="1">
          <mxGeometry x="-414" y="-523" width="897" height="1615" as="geometry"/>
        </mxCell>
        <mxCell id="EWBQogNj3lFvGu2faLvZ-15" value="" style="rounded=0;whiteSpace=wrap;html=1;strokeColor=#FF0000;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="-2052" y="848" width="371" height="20" as="geometry"/>
        </mxCell>
        <mxCell id="EWBQogNj3lFvGu2faLvZ-16" value="" style="curved=1;endArrow=classic;html=1;strokeColor=#FF0000;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.25;entryDx=0;entryDy=0;" edge="1" parent="1" source="EWBQogNj3lFvGu2faLvZ-15" target="EWBQogNj3lFvGu2faLvZ-17">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-1108" y="768" as="sourcePoint"/>
            <mxPoint x="-592" y="623" as="targetPoint"/>
            <Array as="points">
              <mxPoint x="-1119" y="758"/>
              <mxPoint x="-667" y="624"/>
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="EWBQogNj3lFvGu2faLvZ-17" value="" style="rounded=0;whiteSpace=wrap;html=1;strokeColor=#FF0000;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="-250" y="595" width="120" height="17" as="geometry"/>
        </mxCell>
        <mxCell id="EWBQogNj3lFvGu2faLvZ-18" value="&lt;pre style=&quot;background-color: rgb(33 , 33 , 33) ; font-family: &amp;#34;consolas&amp;#34; ; font-size: 10.5pt&quot;&gt;&lt;span style=&quot;color: rgb(199 , 146 , 234) ; font-style: italic&quot;&gt;func &lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: rgb(247 , 140 , 108)&quot;&gt;s &lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: rgb(195 , 232 , 141)&quot;&gt;Server&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: rgb(130 , 170 , 255)&quot;&gt;processStreamingRPC&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: rgb(247 , 140 , 108)&quot;&gt;t &lt;/span&gt;&lt;font color=&quot;#eeffff&quot;&gt;transport&lt;/font&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: rgb(195 , 232 , 141)&quot;&gt;ServerTransport&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: rgb(247 , 140 , 108)&quot;&gt;stream &lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;*&lt;/span&gt;&lt;font color=&quot;#eeffff&quot;&gt;transport&lt;/font&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: rgb(195 , 232 , 141)&quot;&gt;Stream&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: rgb(247 , 140 , 108)&quot;&gt;srv &lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: rgb(195 , 232 , 141)&quot;&gt;service&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: rgb(247 , 140 , 108)&quot;&gt;sd &lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: rgb(195 , 232 , 141)&quot;&gt;StreamDesc&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: rgb(247 , 140 , 108)&quot;&gt;trInfo &lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: rgb(195 , 232 , 141)&quot;&gt;traceInfo&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;) (&lt;/span&gt;&lt;span style=&quot;color: rgb(247 , 140 , 108)&quot;&gt;err &lt;/span&gt;&lt;span style=&quot;color: rgb(199 , 146 , 234)&quot;&gt;error&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;) {&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;   ...&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: rgb(199 , 146 , 234) ; font-style: italic&quot;&gt;if &lt;/span&gt;&lt;span style=&quot;color: rgb(247 , 140 , 108)&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;.&lt;/span&gt;&lt;font color=&quot;#eeffff&quot;&gt;opts&lt;/font&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;.&lt;/span&gt;&lt;font color=&quot;#eeffff&quot;&gt;streamInt &lt;/font&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;== &lt;/span&gt;&lt;font color=&quot;#eeffff&quot;&gt;nil &lt;/font&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;{&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;      &lt;/span&gt;&lt;font color=&quot;#eeffff&quot;&gt;appErr &lt;/font&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;color: rgb(247 , 140 , 108)&quot;&gt;sd&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: rgb(130 , 170 , 255)&quot;&gt;Handler&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;(&lt;/span&gt;&lt;font color=&quot;#eeffff&quot;&gt;server&lt;/font&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;, &lt;/span&gt;&lt;font color=&quot;#eeffff&quot;&gt;ss&lt;/font&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;)  // 这个StreamDesc也就是服务初始化的时候创建好的，就是对proto文件编译产生的文件，go一般是xxx.pb.go&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;   } &lt;/span&gt;&lt;span style=&quot;color: rgb(199 , 146 , 234) ; font-style: italic&quot;&gt;else &lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;{&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;      &lt;/span&gt;&lt;font color=&quot;#eeffff&quot;&gt;info &lt;/font&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;:= &amp;amp;&lt;/span&gt;&lt;span style=&quot;color: rgb(195 , 232 , 141)&quot;&gt;StreamServerInfo&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;{&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;         &lt;/span&gt;&lt;span style=&quot;color: rgb(238 , 255 , 255) ; font-style: italic&quot;&gt;FullMethod&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;:     &lt;/span&gt;&lt;span style=&quot;color: rgb(247 , 140 , 108)&quot;&gt;stream&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: rgb(130 , 170 , 255)&quot;&gt;Method&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;(),&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;         &lt;/span&gt;&lt;span style=&quot;color: rgb(238 , 255 , 255) ; font-style: italic&quot;&gt;IsClientStream&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;: &lt;/span&gt;&lt;span style=&quot;color: rgb(247 , 140 , 108)&quot;&gt;sd&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: rgb(238 , 255 , 255) ; font-style: italic&quot;&gt;ClientStreams&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;,&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;         &lt;/span&gt;&lt;span style=&quot;color: rgb(238 , 255 , 255) ; font-style: italic&quot;&gt;IsServerStream&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;: &lt;/span&gt;&lt;span style=&quot;color: rgb(247 , 140 , 108)&quot;&gt;sd&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: rgb(238 , 255 , 255) ; font-style: italic&quot;&gt;ServerStreams&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;,&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;      }&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;      &lt;/span&gt;&lt;font color=&quot;#eeffff&quot;&gt;appErr &lt;/font&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;= &lt;/span&gt;&lt;span style=&quot;color: rgb(247 , 140 , 108)&quot;&gt;s&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;.&lt;/span&gt;&lt;font color=&quot;#eeffff&quot;&gt;opts&lt;/font&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: rgb(130 , 170 , 255)&quot;&gt;streamInt&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;(&lt;/span&gt;&lt;font color=&quot;#eeffff&quot;&gt;server&lt;/font&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;, &lt;/span&gt;&lt;font color=&quot;#eeffff&quot;&gt;ss&lt;/font&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;, &lt;/span&gt;&lt;font color=&quot;#eeffff&quot;&gt;info&lt;/font&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: rgb(247 , 140 , 108)&quot;&gt;sd&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: rgb(238 , 255 , 255) ; font-style: italic&quot;&gt;Handler&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;   }&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;   &lt;/span&gt;&lt;font color=&quot;#c792ea&quot;&gt;&lt;i&gt;...&lt;/i&gt;&lt;/font&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: rgb(199 , 146 , 234) ; font-style: italic&quot;&gt;return &lt;/span&gt;&lt;span style=&quot;color: rgb(247 , 140 , 108)&quot;&gt;err&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(137 , 221 , 255)&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;" style="rounded=0;whiteSpace=wrap;html=1;strokeColor=#FF0000;fillColor=none;align=left;" vertex="1" parent="1">
          <mxGeometry x="-1968" y="1138" width="1195" height="256" as="geometry"/>
        </mxCell>
        <mxCell id="EWBQogNj3lFvGu2faLvZ-19" value="" style="rounded=0;whiteSpace=wrap;html=1;strokeColor=#FF0000;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="-1856" y="1191" width="206" height="24" as="geometry"/>
        </mxCell>
        <mxCell id="EWBQogNj3lFvGu2faLvZ-20" value="" style="rounded=0;whiteSpace=wrap;html=1;strokeColor=#FF0000;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="-2004" y="914" width="420" height="18" as="geometry"/>
        </mxCell>
        <mxCell id="EWBQogNj3lFvGu2faLvZ-21" value="" style="curved=1;endArrow=classic;html=1;strokeColor=#FF0000;entryX=1;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="EWBQogNj3lFvGu2faLvZ-20" target="EWBQogNj3lFvGu2faLvZ-19">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-1531" y="1024" as="sourcePoint"/>
            <mxPoint x="-1481" y="974" as="targetPoint"/>
            <Array as="points">
              <mxPoint x="-1579" y="939"/>
              <mxPoint x="-1601" y="1098"/>
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="EWBQogNj3lFvGu2faLvZ-23" value="&lt;font color=&quot;#ff0000&quot;&gt;以流式调用为例&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="-1627" y="1107" width="116" height="21" as="geometry"/>
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
